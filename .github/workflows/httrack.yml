name: Mirror Website and Push to New Repo

on:
  repository_dispatch:
    types: [trigger-httrack]

jobs:
  run-httrack:
    runs-on: ubuntu-latest
    steps:
      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y httrack git gh

      - name: Run httrack to mirror website
        run: |
          httrack "${{ github.event.client_payload.website }}" \
            --depth=10 \
            --mirror \
            --user-agent "Mozilla/5.0" \
            --disable-security-limits \
            --robots=0 \
            +*.js

      - name: Configure git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token

      - name: Create a new repository
        env:
          NEW_REPO_NAME: ${{ github.event.client_payload.repo_name }}
        run: |
          # Create a new public repository; add --private if you prefer private.
          gh repo create "${{ github.repository_owner }}/${NEW_REPO_NAME}" --public --confirm

      - name: Initialize repository and push mirror
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          NEW_REPO_NAME: ${{ github.event.client_payload.repo_name }}
        run: |
          git init
          git add .
          git commit -m "Mirrored website from ${{ github.event.client_payload.website }}"
          # Set the remote URL using token-based authentication.
          git remote add origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository_owner }}/${NEW_REPO_NAME}.git
          git push -u origin master
